#!/bin/python3
import subprocess
import getpass
import requests
import sys
import os

tilda = f"/home/{getpass.getuser()}"

def get_web_string(url):
    response = requests.get(url)
    
    if response.status_code == 200:
        return response.text
    else:
        print(f"REQUEST ERR - {response.status_code}")
        sys.exit()

def install(to_install):
    to_install = to_install.lower().strip()
    if to_install == "":
        return

    string = get_web_string(f"https://packages.debian.org/bookworm/amd64/{to_install}/download")

    try:
        string_start = string.index("http://ftp.us.debian.org/debian/pool/main/")
        string = string[string_start:]
        string_end = string.index("\"")
        string = string[:string_end]
    except:
        return

    if subprocess.run(f"dpkg -s {to_install}", shell=True, stdout=subprocess.PIPE, text=True, stderr=subprocess.STDOUT).stdout[0] == 'P':
        print(f"{to_install} PACKAGE ALREADY INSTALLED WITH APT, SKIPPING INSTALL")
        return

    try:
        os.system(f"wget -O {to_install}.deb {string}")

        if not os.path.exists(f"/{tilda}/.pkgsys"):
            os.system(f"mkdir {tilda}/.pkgsys")

        if not os.path.exists(f"/{tilda}/.pkgsys/{to_install}"):
            os.system(f"mkdir {tilda}/.pkgsys/{to_install} && dpkg -x {to_install}.deb {tilda}/.pkgsys/{to_install}")

        else:
            print(f"PATH {tilda}/.pkgsys/{to_install} ALREADY EXISTS, SKIPPING INSTALL")
            return

        add_path_string = f"export PATH=\"{tilda}/.pkgsys/{to_install}/usr/bin/:$PATH\""

        if os.path.exists(f"{tilda}/.pkgsys/{to_install}/usr/lib/x86_64-linux-gnu"):
            add_lib_string = f'export LD_LIBRARY_PATH="{tilda}/.pkgsys/{to_install}/usr/lib/x86_64-linux-gnu/:$LD_LIBRARY_PATH"'
        else:
            add_lib_string = ""

        with open(f"/{tilda}/.pkgrc", "r") as f:
            data = f.read()

        with open(f"/{tilda}/.pkgrc", "w") as f:
            f.write(f"{data}\n{add_path_string}\n{add_lib_string}")

        
        depends = subprocess.run(f"dpkg-deb -f {to_install}.deb Depends", shell=True, stdout=subprocess.PIPE, text=True, stderr=subprocess.STDOUT).stdout
        depends_items = [""]

        paren_mode = False

        for i in range(len(depends)):
            if depends[i] == '(':
                paren_mode = True
                continue
            
            if depends[i] == ')':
                paren_mode = False
                depends_items.append("")
                continue

            if depends[i] == ',':
                continue

            if not paren_mode:
                depends_items[-1] += depends[i]

        for i in depends_items:
            install(i)

        os.remove(f"{to_install}.deb")

        print("INSTALL SUCCESSFUL")

    except Exception as e:
        os.remove(f"{to_install}.deb")
        os.system(f"rm -rf {tilda}/.pkgsys/{to_install}")

        print(f"UNHANDLED ERR - {e}")

if __name__ == "__main__":
    if len(sys.argv) <= 1:
        print("PROGRAM ERR - NO ARGUMENTS")
        sys.exit()

    if sys.argv[1].lower().strip() == "__rcsetup":
        with open(f"{tilda}/.pkgrc", 'w') as f:
            f.write(f"export PATH={tilda}/.pkg/:$PATH\nalias pkgupd=\"source {tilda}/.pkgrc\"")

        sys.exit()

    install(sys.argv[1])
